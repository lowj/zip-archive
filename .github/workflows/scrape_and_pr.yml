name: Scrape and Create PR

on:
  workflow_dispatch: # Allows manual triggering from the Actions tab

jobs:
  run-scraper:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the Archive Repo (Current)
      - name: Checkout Archive Repo
        uses: actions/checkout@v4
        with:
          path: archive
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Checkout the Scraper Repo (External)
      - name: Checkout Scraper Repo
        uses: actions/checkout@v4
        with:
          repository: lowj/zip-scrape
          path: scraper
          token: ${{ secrets.ZIP_SCRAPE_PAT }} # Use the PAT created in prerequisites

      # 3. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' 

      # 4. Install Scraper Dependencies (if any)
      - name: Install dependencies
        run: |
          if [ -f scraper/requirements.txt ]; then pip install -r scraper/requirements.txt; fi

      - name: Playwright install
        run: |
          playwright install

      # 5. Run the Script
      - name: Run Python Script
        run: |
          # We pass the absolute path of the 'archive' directory to the script
          python scraper/zip_scrape_action.py $(pwd)/archive

      # 6. Detect File, Branch, Commit, and Push
      - name: Process Changes and Push
        id: git_ops
        working-directory: archive/archive # Switch context to the archive repo folder
        run: |
          # Configure Git Identity for the bot
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Find the new JSON file (Look for untracked .json files)
          # git status --porcelain outputs "?? filename.json" for new files
          NEW_FILE=$(git status --porcelain | grep ".json" | grep -v "levels.json" | head -n 1 | awk '{print $2}')

          if [ -z "$NEW_FILE" ]; then
            echo "Error: No new JSON file detected."
            exit 1
          fi
          
          echo "Detected new file: $NEW_FILE"

          # Extract the numbers/name from the filename (remove .json extension)
          # Example: "12345.json" becomes "12345"
          BRANCH_NAME=$(basename "$NEW_FILE" .json)
          
          echo "Target Branch Name: $BRANCH_NAME"

          # Create and switch to new branch
          git checkout -b "$BRANCH_NAME"

          # Add files and Commit
          git add .
          git commit -m "Auto-generated update: $BRANCH_NAME"

          # Push the branch
          git push origin "$BRANCH_NAME"

          # Save branch name to output for the next step
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      # 7. Open Pull Request using GitHub CLI
      - name: Create Pull Request
        working-directory: archive
        env:
          GH_TOKEN: ${{ secrets.PR_ACTION}} # Use default token for PRs in same repo
        run: |
          BRANCH_NAME="${{ steps.git_ops.outputs.branch_name }}"
          
          gh pr create \
            --title "$BRANCH_NAME" \
            --body "Automated update generated by the scraper action." \
            --base main \
            --head "$BRANCH_NAME"
